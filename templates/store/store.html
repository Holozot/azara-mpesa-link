{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-pagetop bg">
<div class="container">
    {% if 'search' in request.path %}
        <h2 class="title-page">Search Result</h2>
    {% else %}
        <h2 class="title">{{ current_category }}</h2>
    {% endif %}
</div> 
</section>

<section class="section-content padding-y">
<div class="container">

<div class="row">
    <aside class="col-md-3">
        <div class="card mb-3">
            <article class="filter-group">
                <header class="card-header">
                    <a href="#" data-toggle="collapse" data-target="#collapse_1" aria-expanded="true" class="">
                        <i class="icon-control fa fa-chevron-down"></i>
                        <h6 class="title">Browse Categories</h6>
                    </a>
                </header>
                <div class="filter-content collapse show" id="collapse_1">
                    <div class="card-body">
                        <ul class="list-menu">
                            <li>
                                <a href="{% url 'store:store' %}" class="font-weight-bold" style="color: #333;">All Products</a>
                            </li>
                            
                            {% for category in categories %}
                                {% if not category.parent %} 
                                <li class="mt-3">
                                    <a href="{{ category.get_url }}" class="font-weight-bold" style="color: var(--azara-primary); font-size: 0.9rem;">
                                        {{ category.name }}
                                    </a>

                                    <ul class="list-menu" style="padding-left: 15px; margin-top: 5px; border-left: 2px solid #f0f0f0;">
                                        {% for child in category.children.all %}
                                        <li>
                                            <a href="{{ child.get_url }}" 
                                            class="category-link {% if current_category and current_category == child.name %}active{% endif %}">
                                                {{ child.name }}
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div> 
                </div>
            </article>
        </div>
    </aside>

    <main class="col-md-9">
        <header class="border-bottom mb-4 pb-3">
        
        <div class="d-flex align-items-center justify-content-between">
            <span class="mr-md-auto"><b>{{ product_count }}</b> Items found </span>
            
            <button class="btn btn-outline-primary" type="button" data-toggle="collapse" data-target="#topFilterPanel" aria-expanded="false" aria-controls="topFilterPanel">
                <i class="fa fa-filter"></i> Filter Results
            </button>
        </div>

        <div class="collapse {% if request.GET.min_price or request.GET.brands or request.GET.max_price %}show{% endif %}" id="topFilterPanel">
            <div class="filter-panel-container">
                
                <form id="filterForm" method="GET" class="d-flex flex-wrap align-items-center">
                    
                    {% if 'search' in request.path %}
                    <input type="hidden" name="keyword" value="{{ request.GET.keyword }}">
                    {% endif %}

                    <div class="dropdown mr-3 mb-2">
                        <button class="btn btn-light dropdown-toggle border" type="button" id="brandDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Select Brand
                            {% if selected_brand_ids %}<span class="badge badge-pill badge-primary ml-1">{{ selected_brand_ids|length }}</span>{% endif %}
                        </button>
                        
                        <div class="dropdown-menu filter-dropdown-menu shadow-sm text-left" aria-labelledby="brandDropdown">
                            <h6 class="dropdown-header">Available Brands</h6>
                            
                            <div class="brand-scroll-list">
                                {% for brand in all_brands %}
                                <div class="form-check px-4 py-1">
                                    <input class="form-check-input" type="checkbox" name="brands" value="{{ brand.id }}" id="brand{{ brand.id }}"
                                    {% if selected_brand_ids and brand.id in selected_brand_ids %} checked {% endif %}>
                                    <label class="form-check-label" for="brand{{ brand.id }}">
                                        {{ brand.name }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            </div>
                    </div>

                    <div class="input-group mr-3 mb-2" style="max-width: 250px;">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0">KES</span>
                        </div>
                        <input type="number" class="form-control" name="min_price" id="min_price_input" placeholder="Min" value="{{ request.GET.min_price }}" min="0">
                        <div class="input-group-prepend input-group-append">
                            <span class="input-group-text border-left-0 border-right-0">-</span>
                        </div>
                        <input type="number" class="form-control" name="max_price" id="max_price_input" placeholder="Max" value="{{ request.GET.max_price }}" min="0">
                    </div>

                    <div class="mb-2">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        
                        {% if request.GET.min_price or request.GET.brands or request.GET.max_price %}
                        <a href="{{ request.path }}" class="btn btn-light border ml-2" title="Clear All Filters">
                            Clear
                        </a>
                        {% endif %}
                    </div>

                </form>
                
                <small id="price-error" class="text-danger font-weight-bold d-block mt-2" style="display:none;"></small>
            </div>
        </div>

    </header>
    <div class="row">
        {% if products %}
            {% for product in products %}
            <div class="col-md-4">
                <figure class="card card-product-grid">
                    <div class="img-wrap"> 
                        <a href="{{ product.get_url }}">
                            {% if product.image %}
                                <img src="{{ product.image.url }}">
                            {% else %}
                                <img src="{% static 'images/no_image.png' %}"> 
                            {% endif %}
                        </a>
                    </div> 
                    <figcaption class="info-wrap">
                        <div class="fix-height">
                            <a href="{{ product.get_url }}" class="title">{{ product.name }}</a>
                            <div class="price-wrap mt-2">
                                <span class="price">KES {{ product.get_display_price }}</span>
                            </div> 
                            <p class="text-muted small">{% if product.brand %}{{ product.brand.name }}{% endif %}</p>
                        </div>
                        <a href="{{ product.get_url }}" class="btn btn-block btn-primary">View Details </a>
                    </figcaption>
                </figure>
            </div> 
            {% endfor %}
        {% else %}
            <div class="col-12 mt-5 text-center">
                <h3>No result found.</h3>
                <p>Try clearing your filters.</p>
            </div>
        {% endif %}
    </div> 

    <nav class="mt-4" aria-label="Page navigation">
        {% if products.has_other_pages %}
            <ul class="pagination">
                
                {% if products.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ products.previous_page_number }}&{{ current_filters }}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                {% endif %}

                {% for i in products.paginator.page_range %}
                    {% if products.number == i %}
                    <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}&{{ current_filters }}">{{ i }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if products.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ products.next_page_number }}&{{ current_filters }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
                {% endif %}
            </ul>
        {% endif %}
    </nav>  

    </main> 
</div>

</div> 
</section>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('filterForm');
        const minPriceInput = document.getElementById('min_price_input');
        const maxPriceInput = document.getElementById('max_price_input');
        const errorMsg = document.getElementById('price-error');

        form.addEventListener('submit', function(e) {
            const minPrice = minPriceInput.value ? parseFloat(minPriceInput.value) : 0;
            const maxPrice = maxPriceInput.value ? parseFloat(maxPriceInput.value) : Infinity;
            let hasError = false;
            let message = "";

            if (minPrice < 0) {
                hasError = true;
                message = "Prices cannot be negative.";
            } else if (maxPriceInput.value && maxPrice > 5000) {
                hasError = true;
                message = "Maximum price cannot exceed KES 5000.";
            } else if (maxPriceInput.value && minPrice > maxPrice) {
                hasError = true;
                message = "Min price cannot be greater than Max price.";
            }

            if (hasError) {
                e.preventDefault();
                errorMsg.innerText = message;
                errorMsg.style.display = 'block';
                // Scroll to the error so user sees it
                errorMsg.scrollIntoView({behavior: "smooth", block: "center"});
            } else {
                errorMsg.style.display = 'none';
            }
        });
        
        // Prevent dropdown from closing when clicking inside it (for multiple selections)
        const dropdownMenu = document.querySelector('.filter-dropdown-menu');
        if(dropdownMenu){
            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });
</script>

{% endblock %}