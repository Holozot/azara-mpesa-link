{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
<div class="container">

<div class="card">
    <div class="row no-gutters">
        <aside class="col-md-6">
            <article class="gallery-wrap"> 
                <div class="img-big-wrap">
                   <a href="#"><img src="{{ single_product.image.url }}"></a>
                </div> 
            </article> 
        </aside>
        <main class="col-md-6 border-left">
            <article class="content-body">
            
            <h2 class="title">{{ single_product.name }}</h2>
            
            <div class="mb-3"> 
                <var class="price h4">
                    KES <span id="product_price">
                        {% if variants %}
                            {{ variants.0.price }} {% else %}
                            0.00
                        {% endif %}
                    </span>
                </var> 
            </div> 

            <hr>
            
            <form action="{% url 'cart:add_cart' single_product.id %}" method="POST">
                {% csrf_token %}
                
                {% if variants %}
                <div class="row">
                    <div class="item-option-select">
                        <h6>Select Size</h6>
                        <div class="btn-group btn-group-toggle">
                            
                            {% for variant in single_product.variants.all %}
                            
                            <label class="btn btn-size-selector {% if forloop.first %}active-pink{% endif %}" 
                                onclick="selectSize(this, '{{ variant.price }}')"
                                style="margin-right: 5px; border-radius: 5px; cursor: pointer;">
                                
                                <input type="radio" name="variant_id" value="{{ variant.id }}" 
                                    {% if forloop.first %}checked{% endif %}
                                    style="display:none;" required>
                                
                                {{ variant.size_ml_g }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div> 
                {% endif %}
                
                <div class="col-6">
                    <h6 class="mb-2">Quantity</h6>
                    
                    <input type="hidden" id="current_max_stock" value="{{ single_product.stock|default:0 }}">
                   <div class="input-group input-spinner">
                        <div class="input-group-prepend">
                            <button class="btn btn-light" type="button" id="button-minus"> 
                                <i class="fa fa-minus"></i> 
                            </button>
                        </div>
                        
                        <input type="text" class="form-control" id="quantity_input" name="quantity" value="1" readonly>
                        
                        <div class="input-group-append">
                            <button class="btn btn-light" type="button" id="button-plus"> 
                                <i class="fa fa-plus"></i> 
                            </button>
                        </div>
                    </div>

                <hr>
                
                {% if single_product.available %}
                    <button type="submit" class="btn btn-primary"> 
                        <span class="text">Add to cart</span> 
                        <i class="fas fa-shopping-cart"></i> 
                    </button>
                {% else %}
                     <h5 class="text-danger">Out of Stock</h5>
                {% endif %}
            
            </form>
            </article> 
        </main> 
    </div> 
</div> 
<br>

<div class="row">
    <div class="col-12">
        <header class="section-heading">
            <h3>Product Description</h3>  
        </header>

        <article class="box mb-3 bg-white p-4 shadow-sm rounded">
            <p>
                {{ single_product.description }}
            </p>
        </article>
    </div> 
</div> 

</div>
</section>

<script>
    // 1. CREATE A STOCK MAP
    // This allows JS to know the stock of every variant
    var variantStockMap = {
        {% for variant in single_product.variants.all %}
            "{{ variant.id }}": {{ variant.stock|default:0 }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    
    // 2. MAIN STOCK FALLBACK (Crucial Fix: Added |default:0)
    var mainProductStock = {{ single_product.stock|default:0 }};

    function selectSize(labelElement, price) {
        // A. Update Price
        document.getElementById('product_price').innerText = price;

        // B. Check the Radio Button & Get ID
        var input = labelElement.querySelector('input');
        input.checked = true;
        var variantId = input.value;

        // C. Update the Max Stock Limit based on the ID
        var stockLimit = variantStockMap[variantId];
        
        // Safety check: if undefined (e.g. no variants), use main product stock
        if (stockLimit === undefined) {
            stockLimit = mainProductStock;
        }

        document.getElementById('current_max_stock').value = stockLimit;

        // D. Update Visuals (Pink Buttons)
        var allLabels = document.querySelectorAll('.btn-size-selector');
        allLabels.forEach(function(lbl) {
            lbl.classList.remove('active-pink');
        });
        labelElement.classList.add('active-pink');

        // E. Reset Quantity to 1 (Important when switching sizes)
        document.getElementById('quantity_input').value = "1"; 
    }

    document.addEventListener("DOMContentLoaded", function() {
        const btnMinus = document.getElementById('button-minus');
        const btnPlus = document.getElementById('button-plus');
        const qtyInput = document.getElementById('quantity_input');
        const limitField = document.getElementById('current_max_stock');

        // Hoarding Limit Constant
        const HOARDING_LIMIT = 5;

        // Increase Quantity Logic
        btnPlus.addEventListener('click', function() {
            let currentVal = parseInt(qtyInput.value);
            
            // Added fallback '|| mainProductStock' to prevent NaN errors
            let actualStock = parseInt(limitField.value) || mainProductStock;

            // The Real Limit is the smaller of: 5 OR Actual Stock
            let realLimit = Math.min(HOARDING_LIMIT, actualStock);

            if (currentVal < realLimit) {
                qtyInput.value = currentVal + 1;
            } else {
                // Alert the user why they stopped
                if (actualStock < HOARDING_LIMIT) {
                    alert("Only " + actualStock + " items left in stock.");
                } else {
                    alert("To avoid hoarding, max order is " + HOARDING_LIMIT + " per item.");
                }
            }
        });

        // Decrease Quantity Logic
        btnMinus.addEventListener('click', function() {
            let currentVal = parseInt(qtyInput.value);
            if (currentVal > 1) {
                qtyInput.value = currentVal - 1;
            }
        });
    });
</script>

{% endblock %}